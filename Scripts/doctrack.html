<script src="/style library/js/angular.min.js"></script>
<script type="text/javascript" src="/style library/js/datepickr.js"></script>
<link href='https://fonts.googleapis.com/css?family=Abel' rel='stylesheet' type='text/css'>
<link href="/style library/DocTrack/style.css" rel='stylesheet' type='text/css'>

<div id="angular-app" ng-app="formExample">
    <div ng-form name="dtform" ng-controller="DocumentTracker" class="dt-maindiv" ng-cloak>

        <!-- Access Denied Message-->
        <fieldset ng-show="loaded.all && !(session.isApprover || session.isCreator || session.isEditor || session.isAdmin)">
            <p>You are not authorizied to view this item</p>
        </fieldset>

        <!-- Main Form -->
        <fieldset ng-disabled="data.submitted || session.isViewMode" ng-show="!data.submitted && loaded.all && (session.isApprover || session.isCreator || session.isEditor || session.isAdmin)">
            <a href="#" target="_blank" class="dt-help-link dt-icon" ng-show="!data.submitted && loaded.all"><img alt="Help" src="/style library/DocTrack/question1.png" /></a>    
            <a href="#" ng-click="cancel()" class="dt-exit-link dt-icon"><img alt="Close Form" src="/style library/DocTrack/x.png" /></a>    
            
            <a href="/DocTrack/" class="dt-logo-img"><img alt="Home" src="/style library/DocTrack/logo.png" /></a>    
            <h2 class="dt-header">AO Document Tracker</h2>
            <!-- Section 1 -->
            <fieldset ng-disabled="!(data.status=='Draft' || data.status=='New')" class="dt-group-wrapper">

                <!-- Date and ID -->
                <div class="dt-row">
                    <div class="dt-column"><span class="dt-label">Date: </span><span>{{::data.initDate | date:'shortDate'}}</span></div>
                    <div class="dt-column"><span class="dt-label">ID: </span><span>{{::data.id}}</span></div>
                    <div class="dt-column" ng-show="data.status != 'Draft'"><span class="dt-label">Status: </span><span>{{data.status}}</span></div>
                </div>

                <!-- Document Type -->
                <div class="dt-row">
                    <span class="dt-label">Document Type:<span class="dt-asteriks">*</span></span>
                    <super-select ng-model="data.documentType" all-options="data.allDocumentTypes" source-list-name="documentTypeListName" />
                </div>

                <!-- Title -->
                <div class="dt-row">
                    <p class="dt-label">Subject/Title:<span class="dt-asteriks">*</span></p>
                    <input type="text" ng-model="data.title" size="40" required class="dt-w98" maxlength="255" />
                    <p class="dt-counter">Characters left: {{255 - data.title.length}}</p>
                </div>

                <!-- Due Date, Priority and Sensetive -->
                <div class="dt-row">
                    <div class="dt-column dt-w25">
                        <p class="dt-label">Priority:<span class="dt-asteriks">*</span></p>
                        <input type="radio" ng-model="data.priority" id="dt-prior1" value="High" required /><label for="dt-prior1">High</label><br />
                        <input type="radio" ng-model="data.priority" id="dt-prior2" value="Standard" required /><label for="dt-prior2">Standard</label>
                    </div>
                    <div class="dt-column dt-w25">
                        <p class="dt-label">Due Date:<span class="dt-asteriks">*</span></p>
                        <div>
                            <datepickr ng-model="data.dueDate" clean-date="data.dueDateAsDate" class="max-width250" />
                        </div>
                        <div><span ng-show="data.dueDateAsDate < data.today" class="dt-warning">Due Date cannot be before today</span></div>
                    </div>
                    <div class="dt-column">
                        <p class="dt-label">Does this document contain sensitive information?:<span class="dt-asteriks">*</span></p>
                        <input type="radio" required ng-model="data.sensetive" id="dt-sens2" value="No" /><label for="dt-sens2">No</label><br />
                        <input type="radio" required ng-disabled="data.distribution == 'Attached'" ng-model="data.sensetive" id="dt-sens1" value="Yes" /><label for="dt-sens1">Yes. This document may not be distributed through the AO Document Tracker application</label>
                    </div>
                </div>

            </fieldset>

            <!-- Distribution -->
            <fieldset ng-disabled="data.status=='Cancelled' || data.status == 'Recalled' || data.status=='Closed'" class="dt-group-wrapper">
                <div class="dt-row-no-margin">
                    <p class="dt-label">Document Distribution Method:<span class="dt-asteriks">*</span></p>
                    <input type="radio" required ng-model="data.distribution" id="dt-distr1" value="Attached" ng-disabled="data.sensetive=='Yes' || !(data.status=='Draft' || data.status=='New')" /><label for="dt-distr1">Attached</label>
                    <input type="file" fileread="data.attachment" title="Choose file to upload" class="dt-uploader" ng-disabled="!(data.distribution && data.distribution == 'Attached') || !(data.status == 'Draft' || data.status == 'New')" />
                    <span ng-show="data.distribution=='Attached'">
                        <a href="{{session.webUrl}}/{{session.settings.documentLibraryName}}/{{data.attachmentTitle}}" ng-show="!data.attachmentIsPdf"
                           onclick="return DispEx(this, event, 'TRUE', 'FALSE', 'FALSE', '', '0', 'SharePoint.OpenDocuments', '', '', '', '1434', '0', '0', '0x7fffffffffffffff', '', '')">
                            {{::data.attachmentTitle}}
                        </a>
                        <a href="{{session.webUrl}}/{{session.settings.documentLibraryName}}/{{data.attachmentTitle}}" ng-show="data.attachmentIsPdf"
                           onclick="return DispEx(this, event, 'TRUE', 'FALSE', 'FALSE', '', '0', 'PdfFile.OpenDocuments', '', '', '', '1434', '0', '0', '0x7fffffffffffffff', '', '')">
                            {{::data.attachmentTitle}}
                        </a>
                    </span>
                    <br />
                    <span class="dt-warning" ng-show="data.attachmentTitle && data.attachment">Warning! The old attachment will be replaced with the new one.<br /></span>
                    <input type="radio" required ng-model="data.distribution" id="dt-distr2" value="Email" ng-disabled="!(data.status=='Draft' || data.status=='New')" /><label for="dt-distr2">Email</label><br />
                    <input type="radio" required ng-model="data.distribution" id="dt-distr3" value="Hardcopy" ng-disabled="!(data.status=='Draft' || data.status=='New')" /><label for="dt-distr3">Hardcopy</label><br />
                </div>
            </fieldset>

            <!-- Section 3 -->
            <fieldset ng-disabled="!(data.status=='Draft' || data.status=='New')" class="dt-group-wrapper">

                <!-- Creator comments -->
                <div class="dt-row">
                    <div class="dt-column dt-w25"><p class="dt-label">Initiator: </p><span>{{::data.creator.name}}</span></div>
                    <div class="dt-column">
                        <p class="dt-label">Initiator Comment(s):</p>
                        <textarea class="dt-w98" cols="80" rows="3" maxlength="1000" ng-model="data.creatorComment" ng-disabled="!(data.status=='Draft' || data.status == 'New' && session.isCreator)"></textarea>
                        <p class="dt-counter">Characters left: {{1000 - data.creatorComment.length}}</p>
                    </div>
                </div>

                <!-- Editor comments -->
                <div class="dt-row" ng-show="(data.status=='New' && session.isEditor) || data.editor.name">
                    <div class="dt-column dt-w25"><p class="dt-label">Editor: </p><span>{{::data.editor.name}}</span></div>
                    <div class="dt-column">
                        <p class="dt-label">Editor Comment(s):</p>
                        <textarea class="dt-w98" cols="80" rows="3" maxlength="1000" ng-model="data.editorComment"
                                  ng-disabled="!session.isEditor"></textarea>
                        <p class="dt-counter">Characters left: {{1000 - data.editorComment.length}}</p>
                    </div>
                </div>

                <!-- Approvers -->
                <div class="dt-row" ng-show="data.status=='Draft' || data.status == 'New'">
                    <p class="dt-label">Routing Slip:</p>
                    <my-double-box ng-model="data.approvers" option-source="data.allApprovers" />
                </div>

                <!-- Buttons -->
                <div class="dt-row" ng-show="!session.isViewMode && (data.status=='Draft' || data.status == 'New')" style="position: relative;">
                    <input class="dt-3d-button" type="button" ng-click="save()" value="Save" title="Save changes" />
                    <input class="dt-3d-button" type="button" ng-click="cancel()" value="Cancel" title="Dismiss all changes and go back to list" />
                    <input class="dt-3d-button" type="button" ng-click="initiate()" value="Initiate"
                           ng-attr-title="{{
                       dtform.$invalid ||
                        data.distribution == 'Attached' && !(data.attachment || data.attachmentTitle) ||
                        !data.dueDate ||
                        data.dueDateAsDate < data.today ||
                        !data.approvers ||
                        data.approvers.length == 0
                       ? 'Please complete all required fields' : 'Initiate tracking workflow' }}"
                           title="Please complete all required fields"
                           ng-disabled="
                        dtform.$invalid ||
                        data.distribution == 'Attached' && !(data.attachment || data.attachmentTitle) ||
                        !data.dueDate ||
                        data.dueDateAsDate < data.today ||
                        !data.approvers ||
                        data.approvers.length == 0
                    " />
                    <input class="dt-3d-button" type="button" ng-show="data.status=='New' && (session.isAdmin || session.isCreator || session.isEditor)" ng-click="remove()" value="Remove" title="Remove this item from workflow" style="position: absolute; right: 20px;" />
                </div>

            </fieldset>

            <!-- Comments -->
            <fieldset class="dt-group-wrapper">

                <!-- Slip -->
                <div class="dt-row" ng-show="data.status == 'In Process' || data.status == 'Complete' ||  data.status == 'Closed' ">
                    <p class="dt-label">Routing Slip:</p>
                    <table id="dt-routing-slip-table">
                        <thead class="dt-rs-row">
                            <tr>
                                <th class="dt-rs-column dt-rs-column-receiver">Receiver</th>
                                <th class="dt-rs-column dt-rs-column-date">Date Routed</th>
                                <th class="dt-rs-column dt-rs-column-comment">Comment</th>
                            </tr>
                        </thead>
                        <tbody>

                            <!-- Old Comments -->
                            <tr class="dt-rs-row" ng-repeat="item in data.comments">
                                <td class="dt-rs-column">{{::item.name}}</td>
                                <td class="dt-rs-column">{{::item.date}}</td>
                                <td class="dt-rs-column"><p>{{::item.comment}}</p></td>
                            </tr>

                            <!-- New Comment -->
                            <tr class="dt-rs-row" ng-show="session.isApprover && data.status == 'In Process'">
                                <td class="dt-rs-column">{{data.signer}}</td>
                                <td class="dt-rs-column"></td>
                                <td class="dt-rs-column">
                                    <table class="dt-table-clear">
                                        <tr>
                                            <td><textarea class="dt-w98" maxlength="1000" ng-model="data.newComment" cols="60" rows="3"></textarea></td>
                                            <td><input type="button" ng-click="sign()" value="Sign" title="Sign item" /></td>
                                        </tr>
                                    </table>
                                    <p class="dt-counter">Characters left: {{1000 - data.newComment.length}}</p>
                                </td>
                            </tr>

                            <!-- Empty Comments -->
                            <tr class="dt-rs-row" ng-repeat="item in data.emptySlip" ng-show="!(item.name == data.currentApprover.name && session.isApprover)">
                                <td class="dt-rs-column">{{::item.name}}</td>
                                <td class="dt-rs-column"></td>
                                <td class="dt-rs-column"></td>
                            </tr>

                        </tbody>
                    </table>
                </div>

                <!-- Recall -->
                <div class="dt-row" ng-show="(session.isAdmin || session.isEditor || session.isCreator ) && data.status == 'In Process' || data.recallReason && (data.status == 'Cancelled' || data.status == 'Recalled') ">
                    <p class="dt-label">Recall Reason:</p>
                    <table class="dt-table-clear dt-w50">
                        <tr>
                            <td><textarea ng-model="data.recallReason" maxlength="1000" cols="60" rows="3" ng-disabled="data.status != 'In Process'"></textarea></td>
                            <td><input type="button" ng-show="data.status == 'In Process'" ng-disabled="!data.recallReason" ng-click="recall()" value="Recall" title="Recall this item and remove it from workflow" /></td>
                        </tr>
                    </table>
                    <p class="dt-counter" ng-show="data.status == 'In Process'">Characters left: {{1000 - data.recallReason.length}}</p>
                    <p class="dt-label" ng-show="data.recallReason && (data.status == 'Cancelled' || data.status == 'Recalled')">Recalled by: {{data.recalledBy.name}}</p>
                </div>

            </fieldset>

            <!-- Close Out -->
            <fieldset class="dt-group-wrapper" ng-show="data.status == 'Complete' || data.status == 'Closed'" ng-disabled="data.status == 'Closed' || (!session.isCreator && !session.isEditor)">
                <div class="dt-row-no-margin">
                    <p>
                    <p class="dt-label" ng-show="data.status == 'Complete'">Close Out:<span class="dt-asteriks">*</span> <input type="checkbox" ng-model="data.closedOut" />&nbsp;&nbsp;</p>
                    <span>Close Out By: </span><span ng-show="data.closedOut || data.status == 'Closed'">{{::session.currentUser.name}}</span><br />
                    <span ng-show="data.status == 'Closed'">Close Out Date: {{::data.closedOutDate | date:'shortDate'}}</span>
                    </p>
                    <span ng-show="data.status == 'Complete'">
                        <p><i><b>By closing out this item you are confirming that the document being tracked has been filed appropriately.</b></i></p>
                        <p><i><b>When Save is pressed, the attachment to this tracker item, if any, will automatically be deleted.</b></i></p>
                        <input type="button" ng-click="closeOut()" value="Save" ng-disabled="!data.closedOut" title="Close this item" />
                        <input type="button" ng-click="cancel()" value="Cancel" title="Dismiss all changes and go back to list" />
                    </span>
                </div>
            </fieldset>
        </fieldset>

        <!-- Modal Dialog-->
        <modal-dialog show='modalShown' action="goBackToList" message="modalMessage" />
    </div>
</div>
<script>
    var app = angular.module('formExample', []);

    // FACTORIES
    app.factory('Settings', function () {
        return {
            adminGroupid: 1462, // Prod
            //adminGroupid: 641, // STG DocTrack Admin Techs
            //adminGroupid: 1452, // DEV
            approversListName: "Document Tracker Approvers",
            documentTypeListName: "Document Tracker Document Types",
            documentLibraryName: "Document Tracker Attachments",
            documentFilterQuery: "Forms/AllItems.aspx?FilterField1=Title&FilterValue1="
        }
    });
    app.factory('Session', function (UtilFactory) {
        var currentUser = null;
        var listTitle = null;
        var itemId = null;
        var siteUrl = null;
        var isEditMode = function () {
            return window.location.pathname.indexOf('EditForm.aspx') > -1 || window.location.pathname.indexOf('DispForm.aspx') > -1;
        };
        var isViewMode = function () {
            return window.location.pathname.indexOf('DispForm.aspx') > -1;
        };
        var getCurrentUser = function () {
            return currentUser;
        };
        var getListTitle = function () {
            if (!listTitle) {
                var ar = window.location.pathname.split('/');
                listTitle = ar[ar.indexOf("Lists") + 1];
                var find = "%20";
                var regex = new RegExp(find, "g");
                listTitle = listTitle.replace(regex, " ");
            }
            return listTitle;
        };
        var getItemId = function () {
            if (!itemId)
                itemId = UtilFactory.getUrlParameterByName('ID');
            return itemId;
        };
        var getSiteUrl = function () {
            if (!window.location.origin) {
                window.location.origin = window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port : '');
            }
            if (!siteUrl)
                siteUrl = window.location.origin + _spPageContextInfo.webServerRelativeUrl;
            return siteUrl;
        };
        var getOriginUrl = function () {
            if (!window.location.origin) {
                window.location.origin = window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':' + window.location.port : '');
            }
            return window.location.origin;
        };
        var setItemId = function (id) {
            itemId = id;
        };
        var setCurrentUser = function (user) {
            currentUser = user;
        };
        return {
            isEditMode: isEditMode,
            isViewMode: isViewMode,
            getCurrentUser: getCurrentUser,
            getListTitle: getListTitle,
            getItemId: getItemId,
            getOriginUrl: getOriginUrl,
            getSiteUrl: getSiteUrl,
            setItemId: setItemId,
            setCurrentUser: setCurrentUser
        };
    });
    app.factory('ListDataFactory', function ($q, Session, UtilFactory) {
        var fields = {
            'approver': { type: 'Person', name: 'Approver' },
            'approvers': { type: 'MultiPerson', name: 'Approvers' },
            'attachmentTitle': { type: 'Text', name: 'AttachmentTitle', allowNull: true },
            'closedOutBy': { type: 'Person', name: 'ClosedOutBy' },
            'closedOutDate': { type: 'Date', name: 'ClosedOutDate' },
            'comments': { type: 'JsonArray', name: 'Comments' },
            'creator': { type: 'Person', name: 'Author', readOnly: true },
            'creatorComment': { type: 'Text', name: 'CreatorComment' },
            'currentApprover': { type: 'Person', name: 'CurrentApprover' },
            'currentEmailReceiver': { type: 'Person', name: 'CurrentEmailReceiver' },
            'distribution': { type: 'Text', name: 'Document Distribution' },
            'documentType': { type: 'Text', name: 'Document Type' },
            'dueDate': { type: 'Date', name: 'Due Date' },
            'editor': { type: 'Person', name: 'Editor0' },
            'editorComment': { type: 'Text', name: 'EditorComment' },
            'id': { type: 'Number', name: 'ID', readOnly: true },
            'initDate': { type: 'Date', name: 'Request Date' },
            'isPoc': { type: 'Number', name: 'IsPoc', allowNull: true },
            'poc': { type: 'Person', name: 'POC' },
            'priority': { type: 'Text', name: 'High Priority?' },
            'recalledBy': { type: 'Person', name: 'RecalledBy' },
            'recallReason': { type: 'Text', name: 'RecallReason' },
            'receiver1': { type: 'Text', name: 'Previous Assignee', allowNull: true },
            'receiver2': { type: 'Text', name: 'Current Assignee', allowNull: true },
            'sensetive': { type: 'Text', name: 'isSensetive' },
            'status': { type: 'Text', name: 'Status' },
            'title': { type: 'Text', name: 'Title' }
        };
        var parseDataToItem = function(data, item) {
            for (var key in fields) {
                var field = fields[key];
                if (field.readOnly) continue
                if (!data.hasOwnProperty(key)) continue
                var value = data[key];
                var afterValue;
                switch (field.type) {
                    case 'MultiLookup':
                        if (!value) continue
                        var lookupsIds = typeof value == "string" ? value.split(',') : value;
                        var lookups = [];
                        for (var ii in lookupsIds) {
                            var lookupValue = new SP.FieldLookupValue();
                            lookupValue.set_lookupId(lookupsIds[ii]);
                            lookups.push(lookupValue);
                        }
                        afterValue = lookups;
                        break;
                    case 'JsonArray':
                        if (!value) continue
                        afterValue = angular.toJson(value);
                        break;
                    case 'Person':
                        if (value) {
                            afterValue = SP.FieldUserValue.fromUser(value.title);
                            afterValue.set_lookupId(value.id);
                        } else {
                            afterValue = null;
                        }
                        break;
                    case 'Date':
                        if (!value) continue
                        afterValue = new Date(Date.parse(value));
                        break;
                    case 'MultiPerson':
                        if (!value) continue
                        var lookups = [];
                        var values = angular.fromJson(value);
                        for (var i = 0; i < values.length; i++) {
                            var lookupValue = SP.FieldUserValue.fromUser(values[i].title);
                            lookupValue.set_lookupId(values[i].id);
                            lookups.push(lookupValue);
                        }
                        afterValue = lookups;
                        break;
                    default:
                        if (!value && !field.allowNull) continue
                        afterValue = value;
                }
                var fieldName = field.name.replace(/ /g, '_x0020_');
                var fieldName = fieldName.replace('?', '_x003f_');
                item.set_item(fieldName, afterValue);
            }
            item.update();
        }
        var parseField = function (obj, field) {
            var fieldName = field.name.replace(/ /g, '_x0020_');
            var fieldName = fieldName.replace('?', '_x003f_');
            
            var val = obj[fieldName];

            switch (field.type) {
                case 'MultiLookup':
                    var s = [];
                    for (var i = 0; i < val.length; i++) {
                        var lv = val[i];
                        s.push(lv.get_lookupId());
                    }
                    val = s;
                    break;

                case 'JsonArray':
                    if (val == null) {
                        val = [];
                    } else {
                        val = JSON.parse(val);
                    }
                    break;

                case 'Person':
                    if (!val) return null;
                    var name = val.get_lookupValue();
                    var id = val.get_lookupId();
                    val = { name: UtilFactory.formatName(name), id: id, title: name };
                    break;

                case 'MultiPerson':
                    if (!val) return null;
                    var s = [];
                    for (var i = 0; i < val.length; i++) {
                        var lv = val[i];
                        var name = lv.get_lookupValue();
                        var id = lv.get_lookupId();
                        s.push({ name: UtilFactory.formatName(name), id: id, title: name });
                    }
                    val = s;
                    break;
            }

            return val;
        };
        var parseItemToData = function (item, attFiles) {
            var obj = item.get_fieldValues();
            var data = {};
            for (var key in fields) {
                var field = fields[key];
                var newVal = parseField(obj, field);
                if (newVal != null) data[key] = newVal;
            }
            return data;
        };
        var getAllItems = function (listTitle, loadQuery) {
            var deferred = $q.defer();
            SP.SOD.executeOrDelayUntilScriptLoaded(function () {
                var ctx = SP.ClientContext.get_current();
                var list = ctx.get_web().get_lists().getByTitle(listTitle);
                var query = SP.CamlQuery.createAllItemsQuery();
                var items = list.getItems(query);
                if (loadQuery) {
                    ctx.load(items, loadQuery);
                } else {
                    ctx.load(items);
                }
                ctx.executeQueryAsync(
                    function () {
                        var arr = [];
                        for (var i = 0; i < items.get_count() ; i++) {
                            var item = items.getItemAtIndex(i);
                            arr.push(item.get_fieldValues());
                        }
                        deferred.resolve(arr);
                    },
                    function (e) {
                        console.log('Error: ' + e);
                    }
                );}, 'SP.js');
            return deferred.promise;
        };
        var createItem = function (data) {
            return createItemCustom(data, Session.getListTitle(), function (item) {
                var oData = item.get_objectData();
                var id = oData.$X_0.get_identity().split(',')[0].split('item')[1].substring(1);
                Session.setItemId(id);
            });
        };
        var createItemCustom = function (data, listTitle, success) {
            var deferred = $q.defer();
            var ctx = SP.ClientContext.get_current();
            var item = ctx.get_web().get_lists().getByTitle(listTitle).addItem();
            parseDataToItem(data, item);
            ctx.load(item);
            ctx.executeQueryAsync(function () {
                if (success)
                    success(item);
                deferred.resolve(item);
            }, function (e) {
                deferred.reject(e);
            });
            return deferred.promise;
        };
        var getAttachment = function () {
            var deferred = $q.defer();
            var ctx = SP.ClientContext.get_current();
            var attachmentFolder = ctx.get_web().getFolderByServerRelativeUrl('Lists/' + Session.getListTitle() + '/Attachments/' + Session.getItemId());
            var attachmentFiles = attachmentFolder.get_files();
            ctx.load(attachmentFiles);
            ctx.executeQueryAsync(function () {
                var file = attachmentFiles.getItemAtIndex(0);
                var name = file.get_name();
                var url = file.get_serverRelativeUrl();
                var attach = { name: name, url: url };
                deferred.resolve(attach);
            });
            return deferred.promise;
        }
        var getCurrentItem = function () {
            var deferred = $q.defer();
            SP.SOD.executeOrDelayUntilScriptLoaded(function () {
                var ctx = SP.ClientContext.get_current();
                var item = ctx.get_web().get_lists().getByTitle(Session.getListTitle()).getItemById(Session.getItemId());
                ctx.load(item);
                ctx.executeQueryAsync(function () {
                    var obj = parseItemToData(item);
                    deferred.resolve(obj);
                }, function (e) {
                    deferred.reject(e);
                });
            }, 'SP.js');
            return deferred.promise;
        };
        var updateItem = function (data) {
            var deferred = $q.defer();
            var ctx = SP.ClientContext.get_current();
            var item = ctx.get_web().get_lists().getByTitle(Session.getListTitle()).getItemById(Session.getItemId());
            parseDataToItem(data, item);
            ctx.executeQueryAsync(function () {
                deferred.resolve(item);
            }, function (e) {
                deferred.reject(e);
            });
            return deferred.promise;
        };
        var deleteItem = function (listTitle, id) {
            var deferred = $q.defer();
            var ctx = SP.ClientContext.get_current();
            var item = ctx.get_web().get_lists().getByTitle(listTitle).getItemById(id);
            item.deleteObject();
            ctx.executeQueryAsync(function () {
                deferred.resolve();
            }, function (e) {
                deferred.reject(e);
            });
            return deferred.promise;
        };
        return {
            fields: fields,
            getAllItems: getAllItems,
            createItem: createItem,
            createItemCustom: createItemCustom,
            deleteItem: deleteItem,
            getAttachment: getAttachment,
            getCurrentItem: getCurrentItem,
            updateItem: updateItem,
            parseField: parseField,
            parseItemToData: parseItemToData
        };
    });
    app.factory('UserProfileFactory', function ($q, Settings, Session, UtilFactory) {
        var getCurrentUser = function () {
            var deferred = $q.defer();
            SP.SOD.executeOrDelayUntilScriptLoaded(function () {
                var context = new SP.ClientContext.get_current();
                var web = context.get_web();
                var currentUser = web.get_currentUser();
                currentUser.retrieve();
                context.load(web);
                context.executeQueryAsync(
                    function () {
                        var userObject = web.get_currentUser();
                        var title = userObject.get_title();
                        var id = userObject.get_id();
                        var user = { name: UtilFactory.formatName(title), id: id, title: title};
                        Session.setCurrentUser(user);
                        deferred.resolve(user);
                    },
                    function () {
                        console.log('Error: ' + args.get_message() + '\n' + args.get_stackTrace());
                    }
                );
            }, 'SP.js');
            return deferred.promise;
        };
        var checkUserAdmin = function(user) {
            var deferred = $q.defer();
            SP.SOD.executeOrDelayUntilScriptLoaded(function () {
                try {
                    var ctx = SP.ClientContext.get_current();
                    var group = ctx.get_web().get_siteGroups().getById(Settings.adminGroupid);
                    ctx.load(group, 'Users');
                    ctx.executeQueryAsync(
                        function (sender, args) {
                            var found = false;
                            var e = group.get_users().getEnumerator();
                            while (e.moveNext()) {
                                var admin = e.get_current();
                                if (admin.get_title() == user.title) {
                                    found = true;
                                    break;
                                }
                            }
                            deferred.resolve(found);
                        },
                        function (e) {
                            deferred.resolve(false);
                        });
                } catch (e) {
                    deferred.resolve(false);
                }
            }, 'SP.js');
            return deferred.promise;
        }
        return {
            getCurrentUser: getCurrentUser,
            checkUserAdmin: checkUserAdmin
        };
    });
    app.factory('UtilFactory', function () {
        var getUrlParameterByName = function (name) {
            name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
            var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
                results = regex.exec(location.search);
            return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
        }
        var formatName = function (n) {
            var n = n.split('(')[0].split(',');
            return (n[1] ? n[1].trim() + ' ' : '') + n[0];
        };
        var getIndexByProp = function (array, prop, value) {
            for (var i = 0; i < array.length; i += 1) {
                if (array[i][prop] === value) return i;
            }
            return -1;
        };
        return {
            getIndexByProp: getIndexByProp,
            getUrlParameterByName: getUrlParameterByName,
            formatName: formatName
        }
    });
    app.factory('SoapFactory', function ($q, Session) {
        return {
            deleteAttachment: function (file) {
                var deferred = $q.defer();
                var xmlhttp = new XMLHttpRequest();
                xmlhttp.open('POST', Session.getSiteUrl() + '/_vti_bin/Lists.asmx', true);
                xmlhttp.setRequestHeader("SOAPAction", "http://schemas.microsoft.com/sharepoint/soap/DeleteAttachment");
                xmlhttp.setRequestHeader("Content-Type", 'text/xml; charset="utf-8"');

                var url = Session.getOriginUrl() + file.url;
                var cleanUrl = url.replace(/([^:]\/)\/+/g, "$1");

                var sr =
                    '<?xml version="1.0" encoding="utf-8"?>' +
                    '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">' +
                        '<soap:Body>' +
                        '<DeleteAttachment xmlns="http://schemas.microsoft.com/sharepoint/soap/">' +
                                '<listName>' + Session.getListTitle() + '</listName>' +
                                '<listItemID>' + Session.getItemId() + '</listItemID>' +
                                '<url>' + cleanUrl + '</url>' +
                            '</DeleteAttachment>' +
                        '</soap:Body>' +
                    '</soap:Envelope>';

                xmlhttp.onreadystatechange = function () {
                    if (xmlhttp.readyState == 4) {
                        if (xmlhttp.status == 200) {
                            console.log(xmlhttp.responseText);
                            deferred.resolve(xmlhttp.responseText);
                        }
                    }
                    // TODO: add reject promise
                }
                xmlhttp.send(sr);
                return deferred.promise;
            },
            postItemAttachment: function (filename, binaryString) {
                var deferred = $q.defer();
                var xmlhttp = new XMLHttpRequest();
                var data = binaryString.split(',')[1];
                var url = Session.getSiteUrl() + '/_vti_bin/Lists.asmx';
                var cleanUrl = url.replace(/([^:]\/)\/+/g, "$1");

                xmlhttp.open('POST', cleanUrl, true);
                xmlhttp.setRequestHeader("SOAPAction", "http://schemas.microsoft.com/sharepoint/soap/AddAttachment");
                xmlhttp.setRequestHeader("Content-Type", 'text/xml; charset="utf-8"');

                var sr =
                    '<?xml version="1.0" encoding="utf-8"?>' +
                    '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">' +
                        '<soap:Body>' +
                        '<AddAttachment xmlns="http://schemas.microsoft.com/sharepoint/soap/">' +
                            '<listName>' + Session.getListTitle() + '</listName>' +
                            '<listItemID>' + Session.getItemId() + '</listItemID>' +
                            '<fileName>' + filename + '</fileName>' +
                            '<attachment>' + data + '</attachment>' +
                        '</AddAttachment>' +
                        '</soap:Body>' +
                    '</soap:Envelope>';

                xmlhttp.onreadystatechange = function () {
                    if (xmlhttp.readyState == 4) {
                        if (xmlhttp.status == 200) {
                            deferred.resolve(xmlhttp.responseText);
                        }
                    }

                    // TODO: add reject promise
                }
                xmlhttp.send(sr);
                return deferred.promise;
            },
            postDocument: function (filename, binaryString) {
                var cleanUrl = function (u) { return u.replace(/([^:]\/)\/+/g, "$1") };
                var deferred = $q.defer();
                var xmlhttp = new XMLHttpRequest();
                var data = binaryString.split(',')[1];
                var serviceUrl = cleanUrl(Session.getSiteUrl() + '/_vti_bin/Copy.asmx');
                var fileUrl = cleanUrl(Session.getSiteUrl() + '/Document Tracker Attachments/' + filename);
                var title = filename.replace(/\.[^/.]+$/, "");
                
                xmlhttp.open('POST', serviceUrl, true);
                xmlhttp.setRequestHeader("SOAPAction", "http://schemas.microsoft.com/sharepoint/soap/CopyIntoItems");
                xmlhttp.setRequestHeader("Content-Type", 'text/xml; charset="utf-8"');

                var sr = '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"> \
                    <soap:Body>\
                        <CopyIntoItems xmlns="http://schemas.microsoft.com/sharepoint/soap/">\
                            <SourceUrl>' + filename + '</SourceUrl>\
                                <DestinationUrls>\
                                    <string>' + fileUrl + '</string>\
                                </DestinationUrls>\
                                <Fields>\
                                    <FieldInformation Type="Text" DisplayName="Title" InternalName="Title" Value="' + title + '"  />\
                                </Fields>\
                            <Stream>' + data + '</Stream>\
                        </CopyIntoItems>\
                    </soap:Body>\
                </soap:Envelope>';

                xmlhttp.onreadystatechange = function () {
                    if (xmlhttp.readyState == 4) {
                        if (xmlhttp.status == 200) {
                            deferred.resolve(xmlhttp.responseText);
                        }
                    }
                    // TODO: add reject promise
                }
                xmlhttp.send(sr);
                return deferred.promise;
            }
        }
    });
    
    // CONTROLLERS
    app.controller('DocumentTracker', function ($scope, UserProfileFactory, ListDataFactory, UtilFactory, SoapFactory, Session, $q, $timeout, Settings) {
        window.root = $scope;

        // Utils
        var getCurrentDate = function () {
            var date = new Date();
            return (date.getMonth() + 1) + '/' + date.getDate() + '/' + date.getFullYear();
        };
        var setCurrentEmailReceiver = function () {
            var i = UtilFactory.getIndexByProp($scope.data.allApproversRaw, 'name', $scope.data.currentApprover.name);
            var approver = $scope.data.allApproversRaw[i];
            $scope.data.currentEmailReceiver = approver.poc ? approver.poc : $scope.data.currentApprover;
            $scope.data.isPoc = approver.poc ? 1 : 0;
        };
        var loadingManager = function () {
            var _this = this;
            _this.all = false;
            _this.check = function (v) {
                _this[v] = true;
                for (var k in _this) {
                    var res = true;
                    if (typeof $scope.loaded[k] == "boolean" && k != "all") {
                        res = res && $scope.loaded[k];
                    }
                    $scope.loaded.all = res;
                }
            };
            _this.add = function (k) {
                _this[k] = false;
            }
            return _this;
        };

        // Properties
        $scope.data = {};
        $scope.data.submitted = false;
        $scope.loaded = new loadingManager();
        $scope.session = {};
        $scope.session.isViewMode = Session.isViewMode();
        $scope.session.webUrl = Session.getSiteUrl();
        $scope.session.settings = Settings;
        $scope.data.status = 'Draft';
        $scope.data.today = new Date();
        $scope.modalShown = false;
        
        // Methods
        $scope.handleAttachments = function () {
            var addAtt = function () {
                $scope.data.attachmentTitle = $scope.data.attachment.filename;
                return SoapFactory.postDocument($scope.data.attachment.filename, $scope.data.attachment.data);
            };
            var deleteAtt = function () {
                return $scope.removeAttachment();
            };

            if ($scope.data.distribution && $scope.data.distribution == 'Attached')
                if ($scope.data.attachment && ($scope.data.status == 'New' || $scope.data.status == 'In Process')) {
                    if ($scope.data.attachmentTitle) {
                        return deleteAtt().then(addAtt);
                    } else {
                        return addAtt();
                    }
                }
                
            return $q.when([]);
        };
        $scope.constructor = function () {
            function getCurrentUser() {
                $scope.loaded.add('currentUser');
                UserProfileFactory.getCurrentUser().then(UserProfileFactory.checkUserAdmin).then(function (isAdmin) {
                    $scope.session.currentUser = Session.getCurrentUser();
                    $scope.session.isCreator = false;
                    $scope.session.isEditor = false;
                    $scope.session.isApprover = false;
                    $scope.session.isAdmin = isAdmin;
                    $scope.loaded.check('currentUser');

                    // State and Editor
                    if ($scope.data.status == 'Draft') {
                        $scope.data.creator = $scope.session.currentUser;
                    }
                    else if ($scope.data.status == "New" && $scope.data.creator.name != $scope.session.currentUser.name) {
                        $scope.data.editor = $scope.session.currentUser;
                    }

                    // Creator and Editor
                    if ($scope.data.creator && $scope.data.creator.name == $scope.session.currentUser.name) {
                        $scope.session.isCreator = true;
                    } else
                        if ($scope.data.editor && $scope.data.editor.name == $scope.session.currentUser.name) {
                            $scope.session.isEditor = true;
                        }

                    // Approver
                    if ($scope.data.currentApprover && $scope.data.currentApprover.name == $scope.session.currentUser.name ||
                    $scope.data.currentEmailReceiver && $scope.data.currentEmailReceiver.name == $scope.session.currentUser.name) {
                        $scope.session.isApprover = true;
                    }

                    // Signer
                    if ($scope.data.currentApprover) {
                        $scope.data.signer = $scope.data.currentApprover.name != $scope.session.currentUser.name ?
                        ($scope.data.currentEmailReceiver.name + ' for ' + $scope.data.currentApprover.name) :
                        $scope.data.currentApprover.name;
                    }

                });
            }
            function getAllApprovers() {
                $scope.loaded.add('allApprovers');
                ListDataFactory.getAllItems(Settings.approversListName).then(function (items) {
                    $scope.loaded.check('allApprovers');
                    var arr = [];
                    for (var i = 0; i < items.length; i++) {
                        var item = items[i];
                        var approver = ListDataFactory.parseField(item, ListDataFactory.fields.approver);
                        if (!approver) continue
                        approver.poc = ListDataFactory.parseField(item, ListDataFactory.fields.poc);
                        arr.push(approver);
                    }
                    $scope.data.allApproversRaw = angular.copy(arr);
                    if ($scope.data.approvers) {
                        arr = arr.filter(function (el) {
                            return $scope.data.approvers.map(function (e) { return e.name; }).indexOf(el.name) < 0;
                        });
                    }
                    $scope.data.allApprovers = arr;
                });
            }
            if (Session.isEditMode()) {
                ListDataFactory.getCurrentItem().then(function (obj) {
                    $scope.data = angular.merge($scope.data, obj);
                    $scope.data.emptySlip = $scope.data.approvers.slice($scope.data.comments.length);
                    $scope.data.attachmentUrl = $scope.data.attachmentTitle ? Session.getSiteUrl() + '/' + Settings.documentLibraryName + '/' + Settings.documentFilterQuery + $scope.data.attachmentTitle.replace(/\.[^/.]+$/, "") : '';
                    $scope.data.attachmentIsPdf = $scope.data.attachmentTitle && $scope.data.attachmentTitle.endsWith('.pdf');
                    $scope.master = angular.copy($scope.data);
                    getAllApprovers();
                    getCurrentUser();
                });
            } else {
                getAllApprovers();
                getCurrentUser();
            }
        };
        $scope.goBackToList = function () {
            var s = window.location.href;
            var i = s.indexOf('/NewForm');
            if (i == -1) i = s.indexOf('/EditForm');
            var x = s.substr(0, i);
            window.location = x;
        }; 
        $scope.removeAttachment = function () {
            function deleteById(items) {
                var id = null;
                for (var i = 0; i < items.length; i++)
                    if (items[i].Title == $scope.data.attachmentTitle.replace(/\.[^/.]+$/, ""))
                        id = items[i].ID;
                $scope.data.attachmentTitle = "";
                return ListDataFactory.deleteItem(Settings.documentLibraryName, id);
            }
            return ListDataFactory.getAllItems(Settings.documentLibraryName, 'Include(Title, ID)').then(deleteById);
        };
        $scope.stopTracking = function () {
            $scope.data.receiver1 = "";
            $scope.data.receiver2 = "";
            if ($scope.data.distribution == 'Attached')
                return $scope.removeAttachment().then($scope.write).then($scope.goBackToList)
            else 
                return $scope.write();
        };
        $scope.write = function () {
            return Session.isEditMode() ? ListDataFactory.updateItem($scope.data) : ListDataFactory.createItem($scope.data);
        };
        $scope.toggleModal = function () {
            $scope.modalShown = !$scope.modalShown;
        };

        // Buttons actions
        $scope.cancel = function () {
            $scope.goBackToList();
        };
        $scope.closeOut = function () {
            $scope.data.status = "Closed";
            $scope.data.submitted = true;
            $scope.data.closedOutDate = new Date();
            $scope.stopTracking().then($scope.alertClose);
        };
        $scope.initiate = function () {
            $scope.data.currentApprover = $scope.data.approvers[0];
            $scope.data.receiver2 = $scope.data.currentApprover.name;
            setCurrentEmailReceiver();
            $scope.data.initDate = new Date();
            $scope.data.status = "In Process";
            $scope.data.comments = [];
            $scope.data.submitted = true;
            $scope.handleAttachments().then($scope.write).then($scope.alertInit);
        };
        $scope.recall = function () {
            $scope.data.recalledBy = $scope.session.currentUser;
            $scope.data.status = "Recalled";
            $scope.data.submitted = true;
            $scope.data.attachment = null;
            $scope.stopTracking().then($scope.alertRecall); 

        };
        $scope.remove = function () {
            $scope.data.attachment = null;
            $scope.data.status = "Cancelled";
            $scope.data.submitted = true;
            $scope.stopTracking().then($scope.alertRemove);;
        };
        $scope.save = function () {
            $scope.data.status = "New";
            $scope.data.submitted = true;
            $scope.handleAttachments()
                .then($scope.write)
                .then($scope.alertSave);
        };
        $scope.sign = function () {
            $scope.data.comments.push({ name: $scope.data.signer, comment: $scope.data.newComment, date: getCurrentDate() });
            var index = UtilFactory.getIndexByProp($scope.data.approvers, 'name', $scope.data.currentApprover.name);
            if (index < $scope.data.approvers.length - 1) {
                $scope.data.receiver1 = $scope.data.currentApprover.name;
                $scope.data.currentApprover = $scope.data.approvers[index + 1];
                $scope.data.receiver2 = $scope.data.currentApprover.name;
                setCurrentEmailReceiver();
            } else {
                $scope.data.receiver1 = $scope.data.approvers.length > 1 ? $scope.data.approvers[index - 1].name : null;
                $scope.data.receiver2 = $scope.data.currentApprover.name;
                $scope.data.currentApprover = null;
                $scope.data.currentEmailReceiver = null;
                $scope.data.status = "Complete";
            }
            $scope.data.submitted = true;
            $scope.write().then($scope.alertSign);
        };

        // Alerts
        $scope.showAlert = function (msg) {
            $scope.modalMessage = msg;
            $scope.modalShown = !$scope.modalShown;
            return $q.when([]);
        };
        $scope.alertInit = function () {
            return $scope.showAlert("Document Tracker Item Initiated");
        };
        $scope.alertSave = function () {
            return $scope.showAlert("Document Tracker Item Saved");
        };
        $scope.alertSign = function () {
            return $scope.showAlert("Document Tracker Item Signed");
        };
        $scope.alertRecall = function () {
            return $scope.showAlert("Document Tracker Item Recalled");
        };
        $scope.alertRemove = function () {
            return $scope.showAlert("Document Tracker Item Removed");
        };
        $scope.alertClose = function () {
            return $scope.showAlert("Document Tracker Item Closed");
        };

        // Constructor
        $scope.constructor();
    });

    // DIRECTIVES
    app.directive('myDoubleBox', function ($timeout, UtilFactory) {
        return {
            restrict: 'E',
            scope: {
                ngModel: '=',
                options: '=optionSource'
            },
            template: '<table class="dt-ctrl-approvers" border="1" align="center" style="border-collapse:collapse;"><tr valign="top"><td>' +
                '<select size="8" ng-dblclick="onClickRight()" ng-click="onClickSL()">' +
                    '<option ng-repeat="option1 in options | orderBy: \'name\' " value="{{option1.id}}">{{option1.name}}</option>' +
                '</select></td><td valign="middle">' +
                    '<input type="button" ng-click="onClickRight()" value=">" title="Move selected person right" ng-disabled="options.length==0 || rDisabled" style="width: 80px"/><br /><br />' +
                    '<input type="button" ng-click="onClickLeft()" value="<" title="Move selected person left" ng-disabled="ngModel.length==0 || lDisabled" style="width: 80px"/></td><td>' +
                '<select size="8" ng-dblclick="onClickLeft()" ng-click="onClickSR()" >' +
                    '<option ng-repeat="option2 in ngModel" value="{{option2.id}}">{{option2.name}}</option>' +
                '</select></td></tr><tr><td></td><td></td><td>' +
                    '<input type="button" value="Move Up" ng-click="moveUpDown(false)" title="Move selected person up" ng-disabled="ngModel.length<=1 || uDisabled" />' +
                    '<input type="button" value="Move Down" ng-click="moveUpDown(true)" title="Move selected person down" ng-disabled="ngModel.length<=1 || dDisabled" />' +
                '</td></tr></table>',
            controller: ['$scope', '$element', function (scope, element) {
                scope.ngModel = [];
                var sels = element.find('select');
                var selA = sels[0];
                var selB = sels[1];
                    
                scope.rDisabled = true;
                scope.lDisabled = true;
                scope.uDisabled = true;
                scope.dDisabled = true;

                scope.onClickSL = function () {
                    scope.rDisabled = selA.selectedIndex == -1;
                }

                scope.onClickSR = function () {
                    scope.lDisabled = selB.selectedIndex == -1;
                    scope.dDisabled = selB.selectedIndex == -1 || selB.selectedIndex == selB.length - 1;
                    scope.uDisabled = selB.selectedIndex < 1;
                }

                scope.moveUpDown = function (isDown) {
                    var index = selB.selectedIndex;
                    if (index == -1) { console.log("Please select an option to move."); return; }
                    var temp = scope.ngModel[index];
                    if (isDown) { 
                        scope.ngModel[index] = scope.ngModel[index + 1];
                        scope.ngModel[index + 1] = temp;
                        scope.dDisabled = index >= selB.length - 2;
                        scope.uDisabled = false;
                    } else {
                        scope.ngModel[index] = scope.ngModel[index - 1];
                        scope.ngModel[index - 1] = temp;
                        scope.uDisabled = index < 2;
                        scope.dDisabled = false;
                    }
                }

                scope.onClickLR = function (sel, arrFrom, arrTo) {
                    if (sel.selectedIndex < 0) { console.log("Please select an option to move."); return; }
                    var name = sel.options[sel.selectedIndex].text;
                    var index = UtilFactory.getIndexByProp(arrFrom, 'name', name);
                    if (index === -1) { console.log("Please select an option to move."); return; }
                    var item = arrFrom[index];
                    arrTo.push(item);
                    arrFrom.splice(index, 1);
                    sel.selectedIndex = -1;    
                }

                scope.onClickRight = function () {
                    scope.onClickLR(selA, scope.options, scope.ngModel);
                    scope.rDisabled = true;
                };
                scope.onClickLeft = function () {
                    scope.onClickLR(selB, scope.ngModel, scope.options);
                    scope.lDisabled = true;
                    scope.uDisabled = true;
                    scope.dDisabled = true;
                };
            }]
        };
    });
    app.directive("datepickr", function () {
        return {
            require: "ngModel",
            restrict: "AE",
            scope: {
                ngModel: "=",
                cleanDate: "="
            },
            template: '<input ng-model="dueDate" ng-change="onDateChange()" type="text" readonly="true" class="dt-input-calendar" size="23">\
                        <div style="position: relative"></div>',
            controller: ['$scope', '$element', function (scope, element) {
                var config = {
                    'dateFormat': 'm/d/Y'
                }
                new datepickr(element.find('input')[0], config, element.find('div')[0]);
            }],
            link: function (scope, element, attrs, ngModel) {
                scope.onDateChange = function () {
                    ngModel.$setViewValue(scope.dueDate);
                    scope.cleanDate = new Date(scope.dueDate);
                    scope.cleanDate.setHours(23);
                    scope.cleanDate.setMinutes(59);
                };
                ngModel.$render = function () {
                    if (!ngModel.$modelValue) return;
                    var date = new Date(ngModel.$modelValue);
                    var newDate = (date.getMonth() + 1) + '/' + date.getDate() + '/' + date.getFullYear();
                    ngModel.$modelValue = newDate;
                    scope.dueDate = ngModel.$modelValue;
                };
            }
        };
    });
    app.directive("fileread", [function () {
        return {
            scope: {
                fileread: "="
            },
            link: function (scope, element, attributes, ngModel) {
                element.bind("change", function (changeEvent) {
                    var reader = new FileReader();
                    var filename = changeEvent.target.files[0].name;
                    reader.onload = function (loadEvent) {
                        scope.$apply(function () {
                            scope.fileread = { filename: filename, data: loadEvent.target.result };
                        });
                    }
                    reader.readAsDataURL(changeEvent.target.files[0]);
                });
            }
        }
    }]);
    app.directive('myComments', function () {
        return {
            require: '?ngModel',
            template: '<p ng-repeat="comment in data.comments">{{::comment.Name}}: {{::comment.Comment}}</p>',
        };
    });
    app.directive("superSelect", function (Settings, ListDataFactory) {
        return {
            restrict: 'E',
            require: "ngModel",
            scope: {
                ngModel: '=',
                allOptions: '=',
                sourceListName: '@sourceListName'
            },
            link: function (scope, element, attrs, ngModel) {
                scope.addOption = function () {
                    if (scope.allOptions.indexOf(scope.newOption) > -1) return;
                    if (typeof scope.newOption == 'undefined' || scope.newOption == '') return;
                    scope.allOptions.push(scope.newOption);
                    scope.ngModel = scope.newOption;
                    ListDataFactory.createItemCustom({ title: scope.newOption }, Settings[scope.sourceListName], function () {
                        scope.newOption = "";
                        scope.$apply();
                    });
                    
                }
            },
            controller: function ($scope) {
                ListDataFactory.getAllItems(Settings.documentTypeListName).then(function (items) {
                    $scope.allOptions = items.map(function (v) { return v['Title'] });
                });
            },
            template: 
                '<select class="dt-select-dropdown" ng-model="ngModel" ng-options="item as item for item in allOptions | orderBy" required>\
                </select>\
                <span  class="dt-label" >Other: </span>\
                <input type="text" ng-model="newOption"></input>\
                <input ng-disabled="!newOption || newOption.length == 0" type="button" ng-click="addOption()" value="Add" title="Add custom value to the dropbox"></input>'
        }
    });
    app.directive('modalDialog', function () {
        return {
            restrict: 'E',
            scope: {
                show: '=',
                message: '=',
                action: '='
            },
            replace: true, // Replace with the template below
            transclude: true, // we want to insert custom content inside the directive
            link: function (scope, element, attrs) {
                scope.hideModal = function () {
                    scope.show = false;
                    scope.action();
                };
            },
            template:
                '<div class="ng-modal" ng-show="show">\
                    <div class="ng-modal-overlay" ng-click="hideModal()">\
                        <div class="ng-modal-dialog" >\
                            <p>{{message}}</p>\
                            <input type="button" class="ng-modal-close" ng-click="hideModal()" value="OK" />\
                            <div class="ng-modal-dialog-content" ng-transclude></div>\
                        </div>\
                    </div>\
                </div>'
        };
    });
</script>
